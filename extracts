##Install Kraken2 using
mamba create -n kraken2 kraken2-server

#Building the kraken2 database
kraken2-build --standard --threads 24 --db kraken2db

#Go to the directory that contain the fastq files and iterate over all *_1.fastq.gz files
#!/bin/bash

# Define paths and parameters
KRAKEN2_DB="/mnt/storage7/woranich/kraken2db"  # Path to your Kraken2 database
THREADS=24  # Number of threads to use

# Loop through all *_1.fastq.gz files
for fq1 in ./*_1.fastq.gz; do
  # Derive the corresponding *_2.fastq.gz file
  fq2="${fq1/_1.fastq.gz/_2.fastq.gz}"

  # Ensure the corresponding _2.fastq.gz file exists
  if [[ -f "$fq2" ]]; then
    # Extract the base name for output files
    sample_name=$(basename "$fq1" _1.fastq.gz)

    # Define the output file names
    output_file="${sample_name}.kraken"
    report_file="${sample_name}.kraken.report"

    # Run Kraken2
    kraken2 --db "$KRAKEN2_DB" \
            --paired \
            --threads "$THREADS" \
            --output "$output_file" \
            --use-names \
            --report "$report_file" \
            "$fq1" "$fq2"
    
    # Check if Kraken2 produced the expected output
    if [[ ! -s "$output_file" ]]; then
      echo "Error: Kraken2 failed to produce output for $sample_name."
    else
      echo "Kraken2 processing completed for $sample_name."
    fi

  else
    echo "Warning: Corresponding pair file for $fq1 not found! Skipping..."
  fi
done


##Visualize the kraken output
ls *.kraken | while read -r line ; do rcf -n /mnt/storage7/woranich/retaxdump/taxdump -k $line ; done




